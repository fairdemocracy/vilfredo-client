<!DOCTYPE html>
<!--
****************************************************************************
#
# This file is part of the Vilfredo Client.
#
# Copyright © 2009-2015 Pietro Speroni di Fenizio / Derek Paterson.
#
# VilfredoReloadedCore is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation version 3 of the License.
#
# VilfredoReloadedCore is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License
# for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with VilfredoReloadedCore.  If not, see <http://www.gnu.org/licenses/>.
#
****************************************************************************
-->
<html lang="en"> 
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Vilfredo - Fair Decision-Making</title>
        <meta name="description" content="Vilfredo allows groups from 5 to 20 people to ask open questions and reach consensus in a easy and fair way.">
        <meta name="keywords" content="decision-making, voting, consensus, consensus building, open questions, eParticipation, eGovernment, fair decision">
        <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-title" content="Vilfredo">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">

	
	<link rel=stylesheet type=text/css href="{{ url_for('static', filename='custom-styles/styles.css') }}">
	<link rel=stylesheet type=text/css href="{{ url_for('static', filename='custom-styles/multi-columns-row.css') }}">
    </head>
    <body>
	<div id="navbar"></div>

	<div class="container main">
		
		<div id="completed_box" data-bind="visible: phase() == 'results'">
		<h2>This Question has been Completed!</h2>
		<p>Click on the button below to view the final results.</p>
		<button data-bind="click: show_results" class="btn btn-primary">Show Results</button>
		<br><br><br>
		</div>
		
		<div class="question-view" data-bind="visible: currentUserViewModel.isLoggedIn()">
		<div class="page-header question-info">
			<h1 data-bind="text: title"></h1>
			
		<div class="user_data">
		<div class="media">
        <span class="pull-left">
			<img data-bind="attr: { src: avatar_url }" width="60px" height="60px" class="img-rounded media-object"/> 
        </span>
        <div class="media-body">
            <h5 class="media-heading">by <span data-bind="text: author"></span></h5>
			<p><span data-bind="text: time_dhm(get_timestamp()-last_move_on())"></span> passed since last moved on.</p>
			<p><strong>Generation <span data-bind="text: generation"></span>: <span data-bind="text: phase"></span> phase - 
			<span class="status" data-bind="html: set_question_status()"></span></strong></p>
        </div>
    </div>
</div>	
			<br>
		</div>	
	<div>
	    
	<div id="info_panel">	
	<!-- ko if: questionViewModel.my_permissions() == 1 -->
	<p>With This Question Your Can: <strong><span class="glyphicon glyphicon-eye-open"></span> Read Only</strong></p>
	<p>You have Read Only permission for this question. This means you can follow what's going on but you cannot write proposals or vote.</p>
	<!-- /ko -->
	<!-- ko if: questionViewModel.my_permissions() == 3 -->
	<p>With This Question Your Can: <strong><span class="glyphicon glyphicon-thumbs-up"></span> Vote Only</strong></p>
	<p>You have Vote Only permission for this question. This means you can follow what's going on and vote but you cannot write proposals of your own.</p>
	<!-- /ko -->
	<!-- ko if: questionViewModel.my_permissions() == 5 -->
	<p>With This Question Your Can: <strong><span class="glyphicon glyphicon-pencil"></span> Propose Only</strong></p>
	<p>You have Propose Only permission for this question. This means you can follow what's going on and write your own proposals but you cannot vote.</p>
	<!-- /ko -->
	<!-- ko if: questionViewModel.my_permissions() == 7 -->
	<p>With This Question Your Can: <strong><span class="glyphicon glyphicon-thumbs-up"></span> <span class="glyphicon glyphicon-pencil"></span> Vote and Propose</strong></p>
	<p>You have Vote and Propose permissions for this question. This means you can both write proposals and vote.</p>
	<!-- /ko -->
	</div>
	<br/>
		
	<!-- author controls start -->
	<div class="author_controls" data-bind="visible: author_id() == currentUserViewModel.userid()">
	  <!-- ko if: questionViewModel.phase() == 'writing' -->
	  <!-- ko if: proposalsViewModel.proposals().length < 2 -->
	  <div class="alert alert-info alert-dismissible" role="alert">
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	  <p>Once you have a minimum of 2 proposals you can move the question on to the voting phase. The more proposals you can get the better. Why not <a data-bind="click: permissionsViewModel.open_permissions">involve more people</a> in the writing process?</p>
	   </div>
	<!-- /ko -->
	<!-- ko if: proposalsViewModel.proposals().length >= 2 -->
	<div class="alert alert-success alert-dismissible" role="alert">
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	  <p>Once you have a minimum of 2 proposals you can move the question on to the voting phase. The more proposals you can get the better. Why not <a data-bind="click: permissionsViewModel.open_permissions">involve more people</a> in the writing process?</p>
	   </div>
	<!-- /ko -->
	<!-- /ko -->
	
	<!-- ko if: questionViewModel.phase() == 'voting' -->
	 <!-- ko if: participant_count() > 1 -->
	  <!-- ko if: completed_voter_count() < RESULTS_VOTING_MIN_VOTERS && completed_voter_count() < participant_count() -->
	  <div class="alert alert-info alert-dismissible" role="alert">
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	  <p>Once a minimum of <span data-bind="text: RESULTS_VOTING_MIN_VOTERS"></span> participant(s) have finished voting you can move the question to the results phase or to the next generation. Try to get everyone to vote.</p>
	   </div>
	<!-- /ko -->
	<!-- ko if: completed_voter_count() >= RESULTS_VOTING_MIN_VOTERS && completed_voter_count() < participant_count() -->
	<div class="alert alert-success alert-dismissible" role="alert">
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	  <p>Once a minimum of <span data-bind="text: RESULTS_VOTING_MIN_VOTERS"></span> participant(s) have finished voting you can move the question to the results phase or to the next generation. Try to get everyone to vote.</p>
	   </div>
	<!-- /ko -->
	<!-- ko if: completed_voter_count() >= RESULTS_VOTING_MIN_VOTERS && completed_voter_count() == participant_count() -->
	<div class="alert alert-success alert-dismissible" role="alert">
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	  <p>Congratulations! Everyone has voted! You can now move to results or to the next generation.</p>
	   </div>
	<!-- /ko -->
   <!-- /ko --> <!-- participants > 1 -->
   <!-- ko if: participant_count() == 1 -->
	<!-- ko if: completed_voter_count() == 0 -->
	<div class="alert alert-info alert-dismissible" role="alert">
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
   <p>Once you have finished voting you can move the question to the results phase or to the next generation.</p><p>However, the more people involved the better. Why not <a data-bind="click: permissionsViewModel.open_permissions">involve more people</a> in the voting process?</p>
	</div>
	<!-- /ko -->
	<!-- ko if: completed_voter_count() == 1 -->
	<div class="alert alert-success alert-dismissible" role="alert">
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
   <p>You can move the question to the results phase or to the next generation.</p><p>However, the more people involved the better. Why not <a data-bind="click: permissionsViewModel.open_permissions">involve more people</a> in the voting process?</p>
	</div>
	<!-- /ko -->
   <!-- /ko --> <!-- participants == 1 -->
  <!-- /ko --> <!-- voting -->
		
		<button data-bind="click: permissionsViewModel.open_permissions.bind(), visible: author_id() == currentUserViewModel.userid()" class="btn btn-primary" title="View current Participants and invite new people"><span class="glyphicon glyphicon-user"></span> Participants <span data-bind="text: participant_count" class="badge"></span></button>
		
		<button data-bind="click: questionViewModel.edit, visible: proposal_count() == 0" class="btn btn-primary"><span class="glyphicon glyphicon-pencil"></span> Edit Question</button>
		<button data-bind="click: questionViewModel.delete, visible: proposal_count() == 0" class="btn btn-primary"><span class="glyphicon glyphicon-trash"></span> Delete Question</button>
		
	<!-- ko if: questionViewModel.phase() == 'writing' && questionViewModel.proposal_count() >= 2 && questionViewModel.new_proposal_count() >= 1 -->
	<button data-bind="click: move_on" class="btn btn-primary"><span class="glyphicon glyphicon-refresh"></span> Move to Voting</button>
	<!-- /ko -->
	<!-- ko if: (questionViewModel.phase() == 'voting' && questionViewModel.completed_voter_count() >= MIN_VOTERS_BEFORE_MOVEON) || (questionViewModel.completed_voter_count() == participant_count()) -->
	<button data-bind="click: move_to_results" class="btn btn-primary" title="Move the question to the results phase. This will end the writing and voting cycle and create a results page."><span class="glyphicon glyphicon-thumbs-up"></span> Move to Results</button>
	<button data-bind="click: move_on" class="btn btn-primary"><span class="glyphicon glyphicon-refresh"></span> Move to Next Generation</button>
	<!-- /ko -->
	</div>
	<!-- author controls end -->
	
	<div class="question_access">	
	<!-- ko if: my_permissions() == 1 -->
	<br>
	<div class="alert alert-info" role="alert">
	  <h3>Read Only</h3>
	  <h4>You have been granted read only access to this question.</h4>
	<p>This allows you to follow the deliberation process but you are unable to submit proposals or to vote. You are also unable to write and support proposal comments, to ask and support proposal questions.</p>
	</div>
	<!-- /ko -->
	<!-- ko if: phase() == 'voting' && my_permissions() == 5 -->
	<br>
	<div class="alert alert-info" role="alert">
	<h3>Propose Only !!!</h3>
	<h4>You have been granted propose access to this question.</h4>
	<p>This allows you to write proposals but you are unable to vote.</p>
	</div>
	<!-- /ko -->
	<!-- ko if: phase() == 'writing' && my_permissions() == 5 -->
	<br>
	<div class="alert alert-info" role="alert">
	  <h3>Vote Only !!!</h3>
	<h4>You have been granted vote access to this question.</h4>
	<p>This allows you to vote but you are unable to submit your own proposals.</p>
	</div>
	<!-- /ko -->
	</div>
		
		<br>
		<div class="panel question-info">
			<div class="well">
			    <!-- ko if: USE_MARKDOWN_IN_QUESTION_TEXT -->
			    <span class="blurb" 
			    data-bind="html: $data.blurb()"></span>
			    <!-- /ko -->
			    
			    <!-- ko ifnot: USE_MARKDOWN_IN_QUESTION_TEXT -->
				<span class="blurb" data-bind="html: Autolinker.link(convertNewlines($data.blurb()), {email: false, phone: false, twitter: false})"></span>
				<!-- /ko -->
				<br>
				<div data-bind="visible: phase() == 'writing' && can_propose_ob()">
				<br><br>
				<button data-bind="click: addProposalViewModel().open_addproposal_modal, disable: questionViewModel.finished_writing" type="button" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-share-alt"></span> Submit a Proposal</button>
				
				<a data-bind="click: questionViewModel.set_finished_writing" class="btn btn-primary btn-lg" role="button" title="Click here to inform the author that you have finished writing proposals for this generation of this question"><span class="glyphicon glyphicon-bullhorn"></span> <span data-bind="text: questionViewModel.show_finished_writing()"></span></a>
				</div>	
			</div>
		</div>


		<!-- Participation table start -->
		<br>
		<div id="participationtable" data-bind="visible: questionViewModel.is_author() && questionViewModel.phase() == 'writing'">
			
			<h2>Participation Table</h2>
			<h4 data-bind="text: alternateVotes(selected_generation())"></h4>
			
		<table class="table" width="647">
		<thead>
		<tr>
		<th>User</th>
		<th>Proposals Written</th>
		<th>Proposals Evaluated</th>
<!--		<th>Finished <span data-bind="text: questionViewModel.phase() == 'writing' ? 'Writing' : 'Voting'"></span></th> -->
		<th>Finished <span data-bind="text: 'Writing'"></span></th>
		</tr>
		<tr>
		<th></th>
		<th><span data-bind="text: num_proposals"></span> proposals in total</th>
		<th></th>
		<th></th>
		</tr>
		</thead>
		<tbody>
		<!-- ko foreach: participation_table -->
		<tr>
			<td class="verthdr" data-bind="text: username"></td>
			<td data-bind="text: proposals_written"></td>
			<td data-bind="text: $parent.proposalsEvaluatedText(evaluations), css: $parent.proposalsEvaluatedClass(evaluations)"></td>
			<td data-bind="text: $parent.show_finished_writing_in_table(finished_writing)"></td>
		</tr>
		<!-- /ko -->
		</tbody>
		</table>
			
		</div>
		<!-- Participation table end -->


		</div>
		<!-- question-view end -->

		
		<div id="results_map" data-bind="visible: (questionViewModel.phase() == 'voting' && proposalsViewModel.votedAll)">
				
			<!--
			<div class="btn-group" role="group">
	 	   <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
		      <span data-bind="text: show_pareto_results"></span>
		      <span class="caret"></span>
		    </button>
		    <ul class="dropdown-menu" role="menu">
		      <li><a data-bind="click: $root.select_pf_only.bind($data, false)" href="#">All Proposals</a></li>
		      <li><a data-bind="click: $root.select_pf_only.bind($data, true)" href="#">Pareto Only</a></li>
		    </ul>
		   </div>
			<br><br>
			-->
	
			<h2>Results Map</h2>
			<p>The results map shows the <strong>median</strong> vote for each proposal in grey, the current winning proposals are shown in orange. Click on a median point to display the actual votes from each paticipant.</p>
			<!-- ko if: my_permissions() == 3 || my_permissions() == 7 -->
			<p class="note"><strong>Update</strong> You can now drag your votes to various locations on the map to update your vote. This may also cause the median vote to change.</p>
			<!-- /ko -->
			<button data-bind="click: resultsShowMediansOnly()" id="clearvotes" type="button" class="btn btn-sm btn-primary resultsmapcontrols">Show Medians Only</button>
			
		<!--
		 <div class="btn-group resultsmapcontrols" role="group">
	 	   <button type="button" class="btn btn-sm btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
		      <span data-bind="text: show_pareto_results"></span>
		      <span class="caret"></span>
		    </button>
		    <ul class="dropdown-menu" role="menu">
		      <li><a data-bind="click: select_pf_only.bind($data, false)" href="#">All Proposals</a></li>
		      <li><a data-bind="click: select_pf_only.bind($data, true)" href="#">Winners Only</a></li>
		    </ul>
		   </div>
		-->
			<br>
			<div id="resultstriangle"></div>
			<!-- resultstriangle end -->
		</div> 
		<!-- results_map end -->
		
		
		
		<!-- Graphs -->
		<div id="voting_graphs" data-bind="visible: (questionViewModel.phase() == 'voting' && proposalsViewModel.votedAll) || (questionViewModel.phase() == 'writing' && generation() > 1) || (questionViewModel.phase() == 'results')">
			<br><br>
		<h2>Voting Graph</h2>
		<p>The proposal graph shows how each proposal dominates another according to the voting pattern. The winners are shown in blue at the top.</p>
		<div class="controls text-center">	
			  <button id="vgonly" type="button" class="btn btn-md btn-info">All Proposals</button>
			  <button id="bothgraphs" type="button" class="btn btn-md btn-info">Show Both</button>
			  <button id="pfonly" type="button" class="btn btn-md btn-info">Winning Proposals Only</button>
		</div>
		<br>
		<div class="graphs">
			<div class="singlegraph"></div>
			<div class="graphcontainer">
				<div id="votesgraph" class="leftgraph"></div>
				<div id="pfgraph" class="rightgraph"></div>
			</div>
		</div>
		</div>
		<!-- Graphs end -->
		
		
		<!-- 
		Inherited Proposals 
		-->
		<div data-bind="visible: questionViewModel.phase() == 'writing' && questionViewModel.generation() > 1" class="inherited_proposals narrow">
			
		<div class="page-header">
			<h1>
				Inherited Proposals
			</h1>
			<p>These proposals were inherited from the previous generation:</p>
		</div>
			
		<div class="proposal_list row multi-columns-row">
			<!-- ko foreach: inherited_proposals -->
			<div class="proposal col-xs-6 col-sm-4 col-md-4 col-lg-4">
			<input data-bind="value: id" type="hidden" class="propId" value="">
			<input data-bind="value: $index" type="hidden" class="index" value="">
     		<input data-bind="value: author" type="hidden" class="author" value="">
			<input data-bind="value: uri" type="hidden" class="uri" value="">
			<div data-bind="css: endorse_type" class="panel">
				<div class="panel-heading">
					<h3 class="panel-title" data-bind="text: id() + ': ' + title(), click: $parent.read.bind($data, $index(), 'content')"></h3>
				</div>
				<div class="panel-body proposal-blurb">
					<!-- ko if: questionViewModel.question_type() == 1 -->
					<span data-bind="html: convertNewlines($data.blurb())"></span>  
					<!-- /ko -->
					<!-- ko if: questionViewModel.question_type() == 2 -->
					<img data-bind="attr: { src: image_url }, scaleimage: image_url" width="200px" height="200px"/> 
					<!-- /ko -->
				</div>
				<div class="panel-footer proposal-footer">
					<!--<button data-bind="click: $parent.read" type="button" class="btn btn-s btn-primary">Read</button>-->
					<a title="Open proposal window" data-bind="click: $parent.read.bind($data, $index(), 'content')"><span class="glyphicon glyphicon-new-window"></span></a>
					&nbsp;
					<!-- ko if: questionViewModel.phase() == 'voting' -->
					&nbsp;
					<a title="Open comments window" data-bind="click: $parent.read.bind($data, $index(), 'comments')"><span class="glyphicon glyphicon-comment"></span>&nbsp;<span data-bind="text: comment_count"></span></a>&nbsp;&nbsp;
					<a title="Open questions window" data-bind="click: $parent.read.bind($data, $index(), 'questions')"><span class="glyphicon glyphicon-question-sign"></span>&nbsp;<span data-bind="text: question_count"></span></a>
					<!-- /ko -->
				</div>
			</div>
			</div><!-- /ko -->
		</div>
		</div>
		<!-- 
		Inherited Proposals End
		-->
		
				
		<!-- 
		Current Proposals 
		-->
		<div class="proposals narrow">
		
		<div class="current-proposals">
		<div data-bind="visible: questionViewModel.phase() == 'voting'" class="page-header">
			<h2>
				Current Proposals
			</h2>
			<p data-bind="visible: proposals().length > 0">Vote on all the proposals below:</p>
			<p class="guide"><em>Click on the blue triangles to open the triangular voting map, then click on the map to place your vote. Follow the guides to locate your vote at the location which best represents how much you understand a proposal, and how much you agree or disagree with it.</em></p>
		</div>
		<div data-bind="visible: questionViewModel.phase() == 'writing' && questionViewModel.can_propose" class="page-header">
			<h2>
				Your New Proposals
			</h2>
			<p data-bind="visible: proposals().length > 0">Below are the proposals you have created during the writing phase of this generation:</p>
		</div>
		
		<div data-bind="visible: questionViewModel.proposal_count == 0 && questionViewModel.phase() == 'writing' && questionViewModel.can_propose" class="well highlight">
		<p>There are no new proposals so far. Why not be the first to propose an answer?</p>
		</div>
		
		<div data-bind="visible: proposals().length == 0 && questionViewModel.phase() == 'writing' && questionViewModel.can_propose" class="well highlight">
		<p>You have not written any proposals so far. If you think you have a possible solution, why not propose an answer?</p>
		</div>
		
		<div data-bind="visible: hasVotedAll() == false && questionViewModel.phase() == 'voting'">
		<h2>Still to Vote</h2>
		<p>Below are the proposals you have not yet voted for.</p>
		<br>
		</div>
		<div class="proposal_list row multi-columns-row">
			<!-- ko foreach: proposals -->
			<!-- ko if: isNaN(mapx()) -->
			<div class="proposal col-xs-12 col-sm-4 col-md-4 col-lg-4" data-bind="attr: { pid: id, index: $index }">
			<input data-bind="value: id" type="hidden" class="propId" value="">
			<input data-bind="value: $index" type="hidden" class="index" value="">
     		<input data-bind="value: author" type="hidden" class="author" value="">
			<input data-bind="value: uri" type="hidden" class="uri" value="">
			<div data-bind="css: endorse_type" class="panel">
				<div class="panel-heading" data-bind="style: {color: box_color(), background: box_background(), border: box_background()}">
					<h3 class="panel-title proposal" data-bind="text: id() + ': ' + title(), click: $parent.read.bind($data, $index(), 'content')"></h3>
				</div>
				<div class="panel-body proposal-blurb">
					<!-- ko if: questionViewModel.question_type() == 1 -->
					<span data-bind="html: convertNewlines($data.blurb())"></span>  
					<!-- /ko -->
					<!-- ko if: questionViewModel.question_type() == 2 -->
					<img data-bind="attr: { src: image_url }, scaleimage: image_url" width="200px" height="200px"/> 
					<!-- /ko -->
				</div>
				<div class="panel-footer proposal-footer">
					<a title="Open proposal window" data-bind="click: $parent.read.bind($data, $index(), 'content')"><span class="glyphicon glyphicon-new-window"></span></a>
					&nbsp;
					<!-- ko if: questionViewModel.phase() == 'voting' -->
					&nbsp;
					<a title="Open comments window" data-bind="click: $parent.read.bind($data, $index(), 'comments')"><span class="glyphicon glyphicon-comment"></span>&nbsp;<span data-bind="text: comment_count"></span></a>&nbsp;&nbsp;
					<a title="Open questions window" data-bind="click: $parent.read.bind($data, $index(), 'questions')"><span class="glyphicon glyphicon-question-sign"></span>&nbsp;<span data-bind="text: question_count"></span></a>
					&nbsp;
					<!-- /ko -->
					<a title="Open edit window" data-bind="visible: author_id() == currentUserViewModel.userid() && questionViewModel.phase() == 'writing' && questionViewModel.generation() == generation_created(), click: $parent.edit.bind($data, $index())"><span class="glyphicon glyphicon-pencil"></span></a>
					&nbsp;
					<a title="Delete proposal" data-bind="visible: author_id() == currentUserViewModel.userid() && questionViewModel.phase() == 'writing' && questionViewModel.generation() == generation_created(), click: $parent.delete.bind($data, $index())"><span class="glyphicon glyphicon-trash"></span></a>
					
					<div data-bind="click: $parent.openvotemap.bind($data), visible: questionViewModel.phase() == 'voting'" class="voting"></div>
				</div>
			</div>
			</div>
			<!-- /ko -->
			<!-- /ko -->
		</div>
		</div>
		<!-- 
		Current Proposals End
		-->
		
		<div data-bind="visible: hasVoted() && questionViewModel.phase() == 'voting'">
		<h2>Voted Proposals</h2>
		<p>Below are the proposals you have voted for, ordered by how much you like them. You can change your vote for any of these proposals at any time during the voting phase.</p>
		<br>
		</div>
		
		<div class="proposal_list row multi-columns-row">
			<!-- ko foreach: proposals -->
			<!-- ko if: isNaN(mapx()) == false -->
			<div class="proposal col-xs-12 col-sm-4 col-md-4 col-lg-4" data-bind="attr: { pid: id, index: $index }">
			<input data-bind="value: id" type="hidden" class="propId" value="">
			<input data-bind="value: $index" type="hidden" class="index" value="">
     		<input data-bind="value: author" type="hidden" class="author" value="">
			<input data-bind="value: uri" type="hidden" class="uri" value="">
			<div data-bind="css: endorse_type" class="panel">
				<div class="panel-heading" data-bind="style: {color: box_color(), background: box_background(), border: box_background()}">
					<h3 class="panel-title proposal" data-bind="text: id() + ': ' + title(), click: $parent.read.bind($data, $index(), 'content')"></h3>
				</div>
				<div class="panel-body proposal-blurb">
					<!-- ko if: questionViewModel.question_type() == 1 -->
					<span data-bind="html: convertNewlines($data.blurb())"></span>  
					<!-- /ko -->
					<!-- ko if: questionViewModel.question_type() == 2 -->
		<!--			<img data-bind="attr: { src: image_url }" width="200px" height="200px"/> -->
				<img data-bind="attr: { src: image_url }, scaleimage: image_url" width="200px" height="200px"/> 
		<!--			<img data-bind="propimgsrc: image_url" width="200px" height="200px"/> -->
					<!-- /ko -->
				</div>
				<div class="panel-footer proposal-footer">
					<a title="Open proposal window" data-bind="click: $parent.read.bind($data, $index(), 'content')"><span class="glyphicon glyphicon-new-window"></span></a>
					&nbsp;
					<!-- ko if: questionViewModel.phase() == 'voting' -->
					&nbsp;
					<a title="Open comments window" data-bind="click: $parent.read.bind($data, $index(), 'comments')"><span class="glyphicon glyphicon-comment"></span>&nbsp;<span data-bind="text: comment_count"></span></a>&nbsp;&nbsp;
					<a title="Open questions window" data-bind="click: $parent.read.bind($data, $index(), 'questions')"><span class="glyphicon glyphicon-question-sign"></span>&nbsp;<span data-bind="text: question_count"></span></a>
					&nbsp;
					<!-- /ko -->
					<a title="Open edit window" data-bind="visible: author_id() == currentUserViewModel.userid() && questionViewModel.phase() == 'writing' && questionViewModel.generation() == generation_created(), click: $parent.edit.bind($data, $index())"><span class="glyphicon glyphicon-pencil"></span></a>
					&nbsp;
					<a title="Delete proposal" data-bind="visible: author_id() == currentUserViewModel.userid() && questionViewModel.phase() == 'writing' && questionViewModel.generation() == generation_created(), click: $parent.delete.bind($data, $index())"><span class="glyphicon glyphicon-trash"></span></a>

					<div data-bind="click: $parent.openvotemap.bind($data), visible: questionViewModel.phase() == 'voting'" class="voting"></div>
				</div>
			</div>
			</div>
			<!-- /ko -->
			<!-- /ko -->
		</div>
		</div>
		<!-- 
		Current Proposals End
		-->
		
	</div><!-- /container -->


	<div id="footer"></div> <!-- page end -->
	
	
	<!-- Tri Voting Modal -->
	<div id="vote3waywindow" class="modal fade" tabindex="=1" role="dialog" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-bind="click: close3WayTriangle" aria-hidden="true">&times;</button>
	        <h4 class="modal-title">Please Vote</h4>
	      </div>
	      <div class="modal-body">
			<div class="show3waytriangle"></div>
		  </div><!-- /.modal-body -->
	    </div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
	

	<!-- Continuous Voting Modal -->
	<div id="votemapwindow" class="modal fade" tabindex="=1" role="dialog" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content"> 
	      <div class="vpheader modal-header"> <!-- add here -->
	        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<p class="modal-title"><span id="votemap-thisprop"></span></p>
	      </div>
	      <div class="modal-body">
			<div id="modalvotesmap"></div>
		</div><!-- /.modal-body -->
	    </div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
	
	
	<!-- Edit Question Modal -->
	<div id="editquestion" class="modal fade" tabindex="1" data-backdrop="static" data-keyboard="false" role="dialog" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	        <h4 class="modal-title">Edit a Question</h4>
			<p><strong>Questions may be edited until they receive a proposal.</strong></p>
	      </div>
	      <div class="modal-body">
		<div class="message alert alert-danger"></div>
		
		<form autocomplete="off" class="form-horizontal" role="form"> 
		<div class="form-group">
		    <label for="inputQuestionTitle" class="col-sm-2 control-label">Title</label>
		    <div class="col-sm-10">
			<span class="errormsg" data-bind="validationMessage: title"></span>
		      <input data-bind="value: title" type="text" class="form-control input-lg" id="inputEditQuestionTitle" placeholder="Title">
		    </div>
		  </div>
		  <div class="form-group">
		    <label for="inputQuestionBlurb" class="col-sm-2 control-label">Question Text</label>
		    <div class="col-sm-10">
			<span class="errormsg" data-bind="validationMessage: blurb"></span>
			<textarea data-bind="value: blurb" id="inputEditQuestionBlurb" class="form-control" rows="6" placeholder="Type your question here"></textarea>
		    </div>
		  </div>
		<div class="form-group recaptcha">
		    <div class="col-sm-offset-2 col-sm-10">
				<p>We've detected a lot of links in your text. Please prove you are a person and not a bot.</p>
		      <div class="g-recaptcha" data-sitekey="6LcSkgYTAAAAALuB_Ioey0cKPnjWnxkLts_YVNdU"></div>
		    </div>
		  </div>
		  <div class="form-group">
		    <div class="col-sm-offset-2 col-sm-10">
		      <button data-bind="click: updateQuestion" type="button" class="btn btn-primary">Save Changes</button>
			  <button data-bind="click: close" type="button" class="btn btn-default">Cancel</button>
		    </div>
		  </div>
		</form>
		</div><!-- /.modal-body -->
	    </div><!-- modal-content -->
	  </div><!-- modal-dialog -->
	</div><!-- modal -->

	
	<!-- View Proposal Modal -->
	<div data-bind="with: proposal" id="viewproposal" class="modal fade" tabindex="=1" role="dialog" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div data-bind="css: endorse_type" class="vpheader modal-header">
		  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		
			<div class="row">	
				<div class="col-md-9">
					<div class="row">
						<h4 class="vptitle modal-title"><span data-bind="text: id"></span>: <span data-bind="text: title"></span></h4>
					</div>
					<div class="row">
						<div class="controls">
						<a data-bind="click: showProposalContent"><span class="glyphicon glyphicon-file"></span> Proposal</a>&nbsp;&nbsp;&nbsp;
						<a data-bind="click: showProposalComments"><span class="glyphicon glyphicon-comment"></span> Comments</a>&nbsp;&nbsp;&nbsp;
						<a data-bind="click: showProposalQuestions"><span class="glyphicon glyphicon-question-sign"></span> Questions</a>
						</div> <!-- controls -->
								</div>
				</div>
					<div data-bind="click: openvotemap.bind($data)" class="votebox col-md-3"></div>
			</div>
						
	      </div><!-- modal-header -->
	      <div id="viewproposalbody" class="modal-body">
		
		  <div class="message alert alert-danger"></div>
	
		<div>				
			<div id="propdetails">
				<!-- ko if: questionViewModel.question_type() == 1 -->
					<span data-bind="html: convertNewlines(blurb())"></span>  
					<!-- /ko -->
					<!-- ko if: questionViewModel.question_type() == 2 -->
					<img class="viewproposalimage" data-bind="attr: { src: image_url() }"/> 
					<!-- /ko -->
			</div>
			<div id="showcomments">
				<div class="col-md-6">
					<h4>Points For</h4>
					<div class="comments for">
					<!-- ko foreach: comments -->
					<!-- ko if: comment_type() == 'for' -->
					<div class="comment for">
						<span data-bind="click: viewFullText.bind($data.comment()), html: displayCommentText($data.comment())"></span>
						<div data-bind="css: { supports: $parent.userSupports($data) }" class="select_comment">
						<button data-bind="click: questionViewModel.my_permissions() > 1 ? $parent.toggleCommentSupport : null" type="button" class="btn btn-default btn-xs">agree <span data-bind="text: num_supporters" class="badge"></span></button>
						</div>
					</div>					
					<!-- /ko -->
					<!-- /ko -->
					
					<!-- ko if: questionViewModel.my_permissions() > 1 -->
					<span data-bind="visible: questionViewModel.phase() == 'voting'">
					<textarea data-bind="textInput: comment_for" id="inputForComment" class="form-control" rows="2" placeholder="Point For"></textarea>
					<button data-bind="click: submitComment.bind($data, 'for')" id="inputForCommentBtn" type="button" class="btn btn-default btn-xs">Submit</button>
					</span>
					<!-- /ko -->
					
					</div>
					<!-- for comments end -->
				
				</div>
				<div class="col-md-6">
					<h4>Points Against</h4>
					<div class="comments against">
					<!-- ko foreach: comments -->
					<!-- ko if: comment_type() == 'against' -->
					<div class="comment against">
						<span data-bind="click: viewFullText.bind($data.comment()), html: displayCommentText($data.comment())"></span>
						<div data-bind="css: { supports: $parent.userSupports($data) }" class="select_comment">
						<button data-bind="click: questionViewModel.my_permissions() > 1 ? $parent.toggleCommentSupport : null" type="button" class="btn btn-default btn-xs">agree <span data-bind="text: num_supporters" class="badge"></span></button>
						</div>
					</div>
					<!-- /ko -->
					<!-- /ko -->
					
					<!-- ko if: questionViewModel.my_permissions() > 1 -->
					<span data-bind="visible: questionViewModel.phase() == 'voting'">
					<textarea data-bind="textInput: comment_against" id="inputAgainstComment" class="form-control" rows="2" placeholder="Point Against"></textarea>
					<button data-bind="click: submitComment.bind($data, 'against')" id="inputAgainstCommentBtn" type="button" class="btn btn-default btn-xs">Submit</button>
					</span>
					<!-- /ko -->
					
					</div>
				</div>
			</div> 
			<div id="showquestions">
				<div class="row qaheaders">
					<div class="col-md-6">
						<h4>Questions</h4>
					</div>
					<div class="col-md-6">
						<h4>Answers</h4>
					</div>
				</div>
				<div class="comments">
					<!-- ko foreach: comments -->
					<!-- ko if: comment_type() == 'question' -->
					<div class="qabox row">
						<div class="col-md-6">
							<div class="comment question">
								<div data-bind="click: viewFullText.bind($data.comment()), html: displayCommentText($data.comment())"></div>
								<div data-bind="css: { supports: $parent.userSupports($data) }" class="select_comment">
								<button title="I would also like this question answered" data-bind="click: questionViewModel.my_permissions() > 1 ? $root.toggleCommentSupport : null" type="button" class="btn btn-default btn-xs">like <span data-bind="text: num_supporters" class="badge"></span></button>
								</div>
							</div>
						</div>
						<div class="col-md-6 ans">
							<!-- ko if: $parent.getAnswerObject(id) -->
							<div data-bind="with: $parent.getAnswerObject(id)" class="comment answer">
								<div data-cid="id" data-bind="click: viewFullText.bind($data.comment()), html: displayCommentText($data.comment())"></div>
								<div data-bind="css: { supports: $root.userSupports($data) }" class="select_comment">
								<button title="I think this answers the question" data-bind="click: questionViewModel.my_permissions() > 1 ? $root.toggleCommentSupport : null" type="button" class="btn btn-default btn-xs">like <span data-bind="text: num_supporters" class="badge"></span></button>
								</div>
							</div>
							<!-- /ko -->
															
							<!-- ko ifnot: $parent.getAnswerObject(id) -->
							
							<!-- ko if: $root.proposal.author_id() == currentUserViewModel.user.id && questionViewModel.phase() == 'voting' && (questionViewModel.my_permissions() > 1) -->
							<textarea data-bind="attr: { 'data-commentid': id }" class="inputAnswerComment form-control" rows="3" placeholder="Answer Question"></textarea>
							<button data-bind="click: function() { $root.addcommentanswer(id()) }" type="button" class="btn btn-default btn-xs">answer</button>
							<!-- /ko -->
							
							<!-- ko ifnot: $root.proposal.author_id() == currentUserViewModel.user.id -->
							<div class="comment no-answer">
							<span>No answer yet</span>
							</div>
							<!-- /ko -->
							
							<!-- /ko -->
							
						</div>
					</div>
					<!-- /ko -->
					<!-- /ko -->
					<div class="qabox row">
					<div class="col-md-6">
					<!-- ko if: questionViewModel.my_permissions() > 1 -->
					<span data-bind="visible: questionViewModel.phase() == 'voting'">
					<textarea data-bind="textInput: question" id="inputQuestionComment" class="form-control" rows="2" placeholder="Question"></textarea>
					<button data-bind="click: submitComment.bind($data, 'question')" id="inputQuestionCommentBtn" type="button" class="btn btn-default btn-xs">Submit</button>
					</span>
					<!-- /ko -->
					</div>
					<div class="col-md-6"></div>
					</div>
				</div>
				<!-- question and answers end -->
			</div>
			</div>
		  </div><!-- modal-body -->
		<div class="modal-footer">
		</div><!-- modal-footer -->
	    </div><!-- modal-content -->
	  </div><!-- modal-dialog -->
	</div><!-- modal -->
	
	<!-- Edit Proposal Modal -->
	<div id="editproposal" class="modal fade" tabindex="=1" data-backdrop="static" data-keyboard="false" role="dialog" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	        <h4 class="modal-title">Edit Proposal</h4>
			<p><b>Proposals may be edited until they receive a vote.</b></p>
	      </div>
	      <div class="modal-body">
			<div class="message alert alert-danger"></div>
			<form id="editproposalform" autocomplete="off" class="form-horizontal" role="form" enctype="multipart/form-data">
		  	<div class="form-group">
		    <label for="inputTitle" class="col-sm-2 control-label">Title</label>
		    <div class="col-sm-10">
			  <span class="errormsg" data-bind="validationMessage: title"></span>
		      <input data-bind="value: title" type="text" class="form-control input-lg" id="inputEditProposalTitle" placeholder="Title" name="title">
		    </div>
		  </div>
		<!-- ko if: questionViewModel.question_type() == 1 && addProposalViewModel().blurb().length > PROPOSAL_ABSTRACT_REQUIRED_LENGTH -->
		<div class="form-group">
			<div class="col-sm-2"></div>
			<div class="col-sm-10">
			<div class="progress">
			  <div data-bind="style: { width: abstract_length_pc() }" class="progress-bar progress-bar-success" style="">
			    <span data-bind="text: abstract_length_pc()"></span>
			  </div>
			</div>
			</div>
		    <label for="inputAbstract" class="col-sm-2 control-label">Abstract (optional)</label>
		    <div class="col-sm-10">
			<span class="errormsg" data-bind="validationMessage: abstract"></span>
			<textarea data-bind="value: abstract" id="inputEditProposalAbstract" class="form-control" rows="4" placeholder="Abstract Text" name="abstract"></textarea>
		    </div>
		  </div>
		<!-- /ko -->
		  <div class="form-group" data-bind="visible: questionViewModel.question_type() == 1">
			<div class="col-sm-2"></div>
			<div class="col-sm-10">
			<div class="progress">
			  <div data-bind="style: { width: blurb_length_pc() }" class="progress-bar progress-bar-success" style="">
			    <span data-bind="text: blurb_length_pc()"></span>
			  </div>
			</div>
			</div>
		    <label for="inputBlurb" class="col-sm-2 control-label">Proposal Text</label>
		    <div class="col-sm-10">
			<span class="errormsg" data-bind="validationMessage: blurb"></span>
			<textarea data-bind="value: blurb" id="inputEditProposalBlurb" class="form-control" rows="6" placeholder="Proposal Text" name="blurb"></textarea>
		    </div>
		  </div>
		
		<div class="form-group" data-bind="visible: questionViewModel.question_type() == 2">
		    <label for="edit_image_file_selector" class="col-sm-2 control-label">Image</label>
		    <div class="col-sm-10">
			
			<img id="edit_proposal_current_image" src="" alt="" data-bind="attr: { src: image_url() }" class="selected_upload_image" width="200" height="200"/>
			<img id="edit_proposal_image" src="" alt="" class="selected_upload_image" width="200" height="200"/>
			<br>
			<label class="btn btn-primary" for="edit_image_file_selector">
			    <input id="edit_image_file_selector" type="file" style="display:none;" name="image" onchange="editProposalViewModel().readImageURL(this)">
			    Select Alternate Image
			</label>
		    </div>
		  </div>
		
		  <div class="form-group">
		    <div class="col-sm-offset-2 col-sm-10">
		      <button id="update_prop_btn" data-bind="click: updateProposal, enable: isValid()" type="button" class="btn btn-primary">Save Changes</button>
			  <button data-bind="click: close" type="button" class="btn btn-default">Cancel</button>
		    </div>
		  </div>
		</form>
		</div><!-- /.modal-body -->
	    </div><!-- modal-content -->
	  </div><!-- modal-dialog -->
	</div><!-- modal -->
	
	<!-- New Proposal Modal -->
	<div id="addproposal" class="modal fade" tabindex="=1" data-backdrop="static" data-keyboard="false" role="dialog" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	        <h4 class="modal-title">Add Proposal</h4>
	      </div>
	      <div class="modal-body">
			<div class="message alert alert-danger"></div>
			<form id="newpropform" autocomplete="off" class="form-horizontal" role="form" enctype="multipart/form-data">
		  	<div class="form-group">
		    <label for="inputProposalTitle" class="col-sm-2 control-label">Title</label>
		    <div class="col-sm-10">
			  <span class="errormsg" data-bind="validationMessage: title"></span>
		      <input data-bind="value: title" type="text" class="form-control input-lg" id="inputProposalTitle" placeholder="Title" name="title">
		    </div>
		  </div>
		<!-- ko if: questionViewModel.question_type() == 1 && addProposalViewModel().blurb().length > PROPOSAL_ABSTRACT_REQUIRED_LENGTH -->
		<div class="form-group abstract">
			<div class="col-sm-2"></div>
			<div class="col-sm-10">
				<p class="warning">Abstract required if your proposal is longer than <span data-bind="text: PROPOSAL_ABSTRACT_REQUIRED_LENGTH"></span> characters</p>
			<div class="progress">
			  <div data-bind="style: { width: abstract_length_pc() }" class="progress-bar progress-bar-success" style="">
			    <span data-bind="text: abstract_length_pc()"></span>
			  </div>
			</div>
			</div>
		    <label for="inputProposalAbstract" class="col-sm-2 control-label">Abstract</label>
		    <div class="col-sm-10">
			<span class="errormsg" data-bind="validationMessage: abstract"></span>
			<textarea data-bind="textInput: abstract" id="inputProposalAbstract" class="form-control" rows="4" placeholder="Abstract Text" name="abstract"></textarea>
		    </div>
		  </div>
		<!-- /ko -->
		<div class="form-group" data-bind="visible: questionViewModel.question_type() == 1">
			<div class="col-sm-2"></div>
			<div class="col-sm-10">
			<div class="progress">
			  <div data-bind="style: { width: blurb_length_pc() }" class="progress-bar progress-bar-success" style="">
			    <span data-bind="text: blurb_length_pc()"></span>
			  </div>
			</div>
			</div>
		    <label for="inputBlurb" class="col-sm-2 control-label">Proposal Text</label>
		    <div class="col-sm-10">
			<span class="errormsg" data-bind="validationMessage: blurb"></span>
			<textarea data-bind="textInput: blurb" id="inputProposalBlurb" class="form-control" rows="6" placeholder="Proposal Text" name="blurb"></textarea>
		    </div>
		  </div>
		
		  <div class="form-group" data-bind="visible: questionViewModel.question_type() == 2">
		    <label for="image_file_selector" class="col-sm-2 control-label">Image</label>
		    <div class="col-sm-10">
			  <span class="errormsg" data-bind="validationMessage: title"></span>
		      
			<div id="proposal_image_placeholder" class="upload_image_placeholder"></div>
			<img id="selected_proposal_image" src="" alt="" class="selected_upload_image"/>
			<br>
			<label class="btn btn-primary" for="image_file_selector">
			    <input id="image_file_selector" type="file" style="display:none;" name="image" onchange="addProposalViewModel().readImageURL(this);">
			    Select Image
			</label>
		    </div>
		  </div>
		
		  <div class="form-group">
		    <div class="col-sm-offset-8 col-sm-4">
		      <button id="add_prop_btn" data-bind="click: addProposal, enable: isValid() && add_proposal_jqXHR == null" type="button" class="btn btn-primary">Submit</button>
			  <button data-bind="click: close" type="button" class="btn btn-default">Cancel</button>
		    </div>
		  </div>
		</form>
		</div><!-- /.modal-body -->
	    </div><!-- modal-content -->
	  </div><!-- modal-dialog -->
	</div><!-- modal -->
	
	<!-- FullText Modal -->
	<div id="full_text" class="modal fade" tabindex="=1" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h4 class="modal-title">
						Full Text
					</h4>
				</div>
				<div class="modal-body">
					Hi there baby!!!
				</div><!-- modal-body -->
			</div><!-- modal-content -->
		</div><!-- modal-dialog -->
	</div><!-- FullText modal -->
	
	</div>


	
	<script id="customMessageTemplate" type="text/html">
    <em class="customMessage" data-bind='validationMessage: field'></em>
	</script>

	<!-- HTML5 shim and Respond.js IE8 agree of HTML5 elements and media queries -->
    	<!--[if lt IE 9]>
      	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    	<![endif]-->
		<script type="text/javascript" src="{{ url_for('static', filename='js/settings.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/jquery/1.10.2/jquery.min.js') }}"></script>
    	<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-migrate.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='bootstrap/dist/js/bootstrap.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/knockout-3.2.0.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/knockout-mapping-debug.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/svg-1.5.0/jquery.svg.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/svg-1.5.0/jquery.svgdom.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/svg-1.5.0/jquery.svganim.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/cookies/jquery.cookie.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/purl-master/purl.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/charCount.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/graph.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/vga.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/knockout.validation.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/jqBootstrapValidation.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/ie-row-fix.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='localization/en-US.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/json2.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/amplify.min.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/Autolinker.min.js') }}"></script>
		<script src="https://www.google.com/recaptcha/api.js" async defer></script>
		{{ flask_util_js.js }}
	
	<script type="text/javascript">
	function initPage()
	{
		console.log('initPage called...');
		
		var clickme = $("#clickme");
		$(clickme).on( "click", function(e) {
        	console.log('click on clickme');
        });
        
		$(clickme).on( "mousedown", function(e) {
        	console.log('mousedown on clickme');
        });
		$(clickme).on( "mouseup", function(e) {
        	console.log('mouseup on clickme');
        });

		
		$.when(currentUserViewModel.loadUser(), 
			   questionViewModel.fetchQuestion(),
			   questionViewModel.fetchVotingData()).done(function()
		{
			console.log('User and question loaded...');
			$('.question-view, .current-proposals').show();
			
			$('html head title').text('Vilfredo - ' + questionViewModel.title())
			
			// Load Templates
			if (typeof(LOAD_GOOGLE_ANALYTICS) != "undefined" && LOAD_GOOGLE_ANALYTICS)
			{
			$.get( STATIC_FILES + "/templates/analytics.template.html", function( template ) 
			{
    				$('head').prepend( template );
			});
			}
			$.get( STATIC_FILES + "/templates/navbar.template.html", function( template ) 
			{
				$( "#navbar" ).html( template );
				ko.applyBindings(currentUserViewModel, $('#navbar')[0]);
				$('.home').attr('href', VILFREDO_URL);
			});
			$.get( STATIC_FILES + "/templates/footer.template.html", function( template ) 
			{
				$( "#footer" ).html( template );
				ko.applyBindings(currentUserViewModel, $('#footer')[0]);
			});
			
			$.get( STATIC_FILES + "/templates/login.template.html", function( template ) 
			{
				$('body').append( template )
				ko.applyBindings(loginViewModel, $('#login')[0]);
				$('#login').on('hide.bs.modal', function(e) {
					loginViewModel().clear();
				});
				$('.pwdresetlink').attr('href', VILFREDO_URL+'/lostpassword');
			});
			
			$.get( STATIC_FILES + "/templates/register.template.html", function( template ) 
			{
				$('body').append( template )
				ko.applyBindings(registerViewModel, $('#register')[0]);
				$('#register').on('hide.bs.modal', function(e) {
					registerViewModel().clear();
				});
			});
			
			$.get( STATIC_FILES + "/templates/participants.template.html", function( template ) 
			{
				$('body').append( template )
				ko.applyBindings(permissionsViewModel, $('#participants')[0]);
			});
			
			$.get( STATIC_FILES + "/templates/add_users.template.html", function( template ) 
			{
				$('body').append( template )
				ko.applyBindings(inviteUsersViewModel, $('#add_users')[0]);
			});
			
			questionViewModel.selected_algorithm(2);
			
			if (questionViewModel.phase() == 'writing')
		    {
				//proposalsViewModel.fetchInheritedProposals();
				//proposalsViewModel.fetchProposals({user_only: true});
				$.when(proposalsViewModel.fetchInheritedProposals(), 
			    	   proposalsViewModel.fetchProposals({user_only: true})).done(function()
			    {
					fetchGraphs(questionViewModel.selected_algorithm()); // boots
					if (currentUserViewModel.isLoggedIn())
					{
						//resetGraphsForUser();
					}
					questionViewModel.fetchParticipationTable();
					if (questionViewModel.question_type() == 2)
					{
						//scaleProposalImages();
					}
					checkForNewQuestion();
				});

		    }
		    else if (questionViewModel.phase() == 'voting' || questionViewModel.phase() == 'results')
		    {
		        //proposalsViewModel.fetchProposals();
				$.when(proposalsViewModel.fetchProposals()).done(function()
			    {
					if (proposalsViewModel.votedAll())
					{
							$('#resultstriangle').svg({onLoad: createResultsMap});
					}
					
					if (questionViewModel.question_type() == 2)
					{
						$('.proposal-blurb').css('padding', '0');
						//scaleProposalImages();
					}
					
					fetchGraphs(questionViewModel.selected_algorithm()); // boots
					if (currentUserViewModel.isLoggedIn())
					{
						resetGraphsForUser();
					}
				});
		    }
		
			var qid = questionViewModel.id();
			var gid = questionViewModel.generation();
			$('.alglink').attr('href', VILFREDO_URL + '/domination/' + qid + '/gen/' + gid);
			
			$('#invited_intro').show();
			
			checkVGAMessages();
			
			var resize_timer;
    		$(window).resize(function() 
			{
		        clearTimeout(resize_timer);
		        resize_timer = setTimeout(function() 
				{
					resizeResultsMap();
					resizeSingleGraph();
					resizeVoteMap();
		        }, 500);
		    });
		});
	}
	
	$(function() 
	{
		currentUserViewModel = new CurrentUserViewModel();
		proposalsViewModel = new ProposalsViewModel();
		addProposalViewModel = ko.validatedObservable( new AddProposalViewModel() );
		editProposalViewModel = ko.validatedObservable( new EditProposalViewModel() );
		loginViewModel = ko.validatedObservable( new LoginViewModel() );
		registerViewModel = ko.validatedObservable( new RegisterViewModel() );
		voteMapViewModel = new VoteMapViewModel();
		passwordResetViewModel = ko.validatedObservable( new PasswordResetViewModel() );
		//editQuestionViewModel = ko.validatedObservable( new EditQuestionViewModel() );

		
		//newCommentViewModel = new NewCommentViewModel();
		newCommentViewModel = ko.validatedObservable( new NewCommentViewModel() );
		
		threeWayVoteViewModel = new ThreeWayVoteViewModel();
		viewProposalViewModel = new ViewProposalViewModel();
		questionViewModel = new QuestionViewModel();
		permissionsViewModel = new PermissionsViewModel();
		inviteUsersViewModel = new InviteUsersViewModel();
		
		initPage();
		
		$('#viewproposal').on('shown.bs.modal', function() {
			//console.log('votemapwindow modal shown...');
			viewProposalViewModel.displayProposalContent();
			
			if (questionViewModel.phase() == 'voting' && questionViewModel.can_vote)
			{
				$('.votebox').svg({loadURL: STATIC_FILES + '/images/triangle_b.svg'});
			}
			
			switch(viewProposalViewModel.panel)
			{
			   case 'comments':
			       viewProposalViewModel.showProposalComments();
			       break;
			   case 'questions':
			       viewProposalViewModel.showProposalQuestions();
			       break;
			   default:
			       break;
			}
		});
		$('#viewproposal').on('hidden.bs.modal', function () {
			console.log('viewproposal hidden...');
			viewProposalViewModel.reset();
		});	
		
		$('#votemapwindow').on('shown.bs.modal', function() {
			console.log('votemapwindow modal shown...');
			if (questionViewModel.voting_type() == 1)
			{
				$('#modalvotesmap').svg({onLoad: createVoteMap}); 
			}
			else
			{
				$('#modalvotesmap').svg({onLoad: createVoteMapLinear}); 
			}
		});
		
		$('#votemapwindow').on('hide.bs.modal', function() {
			console.log('votemapwindow modal about to close, destroy map...');
			$('#modalvotesmap').svg('destroy');
			$('#votemap-thisprop').html('');
		});
		
		$('#fullt_text').on('hide.bs.modal', function() {
			$("#full_text .modal-body").html('');
		});
		
		ko.validation.init({ insertMessages: false, decorateElement: true, errorClass: "errormsg" });
		
		$(".question-info").each(function(){
		    ko.applyBindings(questionViewModel, $(this)[0]);
		});
		
		
		ko.applyBindings(questionViewModel, $('#info_panel')[0]);
		ko.applyBindings(questionViewModel, $('.author_controls')[0]);
		ko.applyBindings(questionViewModel, $('.question_access')[0]);
		
		
		ko.applyBindings(questionViewModel, $('#completed_box')[0]);
		//ko.applyBindings(editQuestionViewModel, $('#editquestion')[0]);
		//ko.applyBindings(questionViewModel, $('#edit_question_buttons')[0]);
	
		//ko.applyBindings(loginViewModel, $('#login')[0]);
		
		$(".proposals").each(function(){
		    ko.applyBindings(proposalsViewModel, $(this)[0]);
		});
		ko.applyBindings(proposalsViewModel, $('.inherited_proposals')[0]);
		
		//ko.applyBindings(proposalsViewModel, $('.winning_proposals')[0]);
		
		
		ko.applyBindings(questionViewModel, $('#participationtable')[0]);
		ko.applyBindings(questionViewModel, $('#results_map')[0]);
		ko.applyBindings(questionViewModel, $('#voting_graphs')[0]);
		
		
		//ko.applyBindings(permissionsViewModel, $('#participants')[0]); //shark
		//ko.applyBindings(inviteUsersViewModel, $('#add_users')[0]); //shark
		
		
		//ko.applyBindings(proposalsViewModel, $('#keyplayer_info')[0]);
				
		ko.applyBindings(viewProposalViewModel, $('#viewproposal #propdetails')[0]);
		ko.applyBindings(viewProposalViewModel, $('#viewproposal #showcomments')[0]);
		ko.applyBindings(viewProposalViewModel, $('#viewproposal #showquestions')[0]);
		ko.applyBindings(viewProposalViewModel, $('#viewproposal .vpheader')[0]);
		//ko.applyBindings(newCommentViewModel, $('.newcommentpanel')[0]);
		//ko.applyBindings(currentUserViewModel, $('.navbar')[0]);
		
		//ko.applyBindings(registerViewModel, $('#register')[0]);
		ko.applyBindings(addProposalViewModel, $('#addproposal')[0]);
		ko.applyBindings(editProposalViewModel, $('#editproposal')[0]);
		ko.applyBindings(threeWayVoteViewModel, $('#vote3waywindow')[0]);
		
		ko.applyBindings(voteMapViewModel, $('#votemapwindow')[0]);

		$('#vote3waywindow').on('hidden.bs.modal', function () {
  			console.log('vote3waywindow hidden...');
			$(this).find('.show3waytriangle').svg('destroy');
		});
		
		$('#editproposal').on('shown.bs.modal', function () {
			$("#inputEditProposalBlurb, #inputEditProposalAbstract, #inputEditProposalTitle").trigger('setcharcount');
		});
		
		
		$('#viewproposal').on('shown.bs.modal', function () {
			// scale image
			var prop_image = $('.viewproposalimage');
			if (prop_image.length > 0)
			{
				var image = new Image();
				image.src = prop_image.attr('src');
				var w = image.width;
				var h = image.height;
				var container = $('#propdetails');
				var container_w = container.innerWidth();
				var container_h = container.innerHeight();
				
				if (container_w < container_h)
				{
	                var show_h = container_w / w  * h;
	                var show_w = container_w;
				}
				else
				{
					var show_w = container_h / h  * w;
	                var show_h = container_h;
				}
			
				prop_image
					.width(show_w)
                    .height(show_h);
			}
		}); 
		
		/*
		$('#addproposal').on('hide.bs.modal', function(e) {
			console.log("Hiding addproposal modal!!!");
			$(this).find(".form-control").val('').trigger("setcharcount");
			addProposalViewModel().clear();
			$(this).find("button").removeAttr('disabled');
			
			
			$('#selected_proposal_image')
                    .attr('src', '').width(0).height(0);
			var control = $("#image_file_selector");
			control.replaceWith( control = control.clone( true ) );
			
			var placeholder = $('#proposal_image_placeholder');
			if (placeholder.length)
			{
				placeholder.show();
			}
		});*/
		
		/*
		$('#viewproposal').on('shown.bs.modal', function(e) {
			$(this).find("textarea").val('');
		});
		*/
		
		//
		// comment boxes
		//
		$('#inputForComment').on('click', function (e) {
			$(this).data('clicked', true);
			e.stopPropagation();
		});
		$('#inputAgainstComment').on('click', function (e) {
			$(this).data('clicked', true);
			e.stopPropagation();
		});
		
		//$('.home').attr('href', VILFREDO_URL);
		//$('.navbar-brand').attr('href', VILFREDO_URL);

		/*
		$('body').popover({
		    selector: '[rel="popover"]',
			trigger: 'hover',
			html: true,
			placement: 'top',
			content: 'hello world',
			title: 'Add your vote',
			content: '<div class="poptriangle"></div>'
		});*/
		
		$('body').on('show.bs.popover', function () {
  			//console.log('popover displayed...');
		});
		$('body').on('hidden.bs.popover', function () {
  			//console.log('popover hidden...');
		});	
		
		$("#inputEditProposalTitle").charCount({
			allowed: 120,		
			warning: 10,
			counterText: "Characters Left" + " "
		});
		
		$("#inputEditProposalBlurb").charCount({
			allowed: 10000,		
			warning: 9950,
			counterText: "Characters left" + " "
		});
		
		$("#inputEditProposalAbstract").charCount({
			allowed: 5000,		
			warning: 4950,
			counterText: "Characters left" + " "
		});
		
		$("#inputProposalTitle").charCount({
			allowed: 120,		
			warning: 10,
			counterText: "Characters Left" + " "
		});
		
		$("#inputProposalBlurb").charCount({
			allowed: 10000,		
			warning: 9950,
			counterText: "Characters left" + " "
		});
	
		
		/*
		$("#inputProposalAbstract").charCount({
			allowed: 5000,		
			warning: 4950,
			counterText: "Characters left" + " "
		});*/
		
		$('#inputProposalAbstract').on('click', function(e) {
			if ($(this).data('charcount') == undefined)
			{
				$(this).data('charcount', true);
				$(this).charCount({
					allowed: 5000,		
					warning: 4950,
					counterText: "Characters left" + " "
				});
			}
		});
		
		$('.inputAnswerComment').on('click', function(e) {
			if ($(this).data('charcount') == undefined)
			{
				$(this).data('charcount', true);
				$(this).charCount({
					allowed: 1000,		
					warning: 900,
					counterText: "Characters left" + " "
				});
			}
		});
		
		
		$("#inputQuestionComment").charCount({
			allowed: 1000,		
			warning: 900,
			counterText: "Characters left" + " "
		});
		
		$(".comments.for textarea").charCount({
			allowed: 1000,		
			warning: 900,
			counterText: "Characters left" + " "
		});
		
		$(".comments.against textarea").charCount({
			allowed: 1000,		
			warning: 900,
			counterText: "Characters left" + " "
		});
				
		$("[data-toggle='tooltip']").tooltip();
		
		/*
		$('#clearvotes').on( "click", function(e) {
 	   		e.stopPropagation();
	        $('#resultstriangle #allvotes, #resultstriangle #alluservotes').remove();
			var triangle = $('#results_triangle');
		    if (triangle.length == 1) 
		    {
		    	triangle.data('settings', {'mode': 'default'});
		    }
	    });
	*/
	});	
	</script>
	</body>
</html>
